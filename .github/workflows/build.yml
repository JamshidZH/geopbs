name: Build Portable Basemap Server

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install NuGet
        uses: NuGet/setup-nuget@v2

      # Retarget .NET Framework v4.0 -> v4.6.2 so hosted runner can build
      - name: Retarget projects to .NET Framework 4.6.2
        shell: pwsh
        run: |
          $files = @(
            "PortableBasemapServer\PortableBasemapServer.csproj",
            "PBSRestService\PBS.csproj"
          )

          foreach ($f in $files) {
            if (-not (Test-Path $f)) { throw "Missing project file: $f" }

            $xml = Get-Content $f -Raw

            # old-style csproj
            $xml = $xml -replace "<TargetFrameworkVersion>v4\.0</TargetFrameworkVersion>", "<TargetFrameworkVersion>v4.6.2</TargetFrameworkVersion>"
            $xml = $xml -replace "<TargetFrameworkVersion>v4\.0</TargetFrameworkVersion>", "<TargetFrameworkVersion>v4.6.2</TargetFrameworkVersion>"

            Set-Content -Path $f -Value $xml -Encoding UTF8
          }

      - name: Restore NuGet for projects
        shell: pwsh
        run: |
          nuget restore PortableBasemapServer\PortableBasemapServer.csproj
          nuget restore PBSRestService\PBS.csproj

      - name: Build PBSRestService (Release Any CPU)
        shell: pwsh
        run: |
          msbuild PBSRestService\PBS.csproj /m /t:Rebuild /p:Configuration=Release /p:Platform="Any CPU"

      - name: Build PortableBasemapServer (Release x86)
        shell: pwsh
        run: |
          msbuild PortableBasemapServer\PortableBasemapServer.csproj /m /t:Rebuild /p:Configuration=Release /p:Platform="x86"

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            PortableBasemapServer\bin\**
            PBSRestService\bin\**
